name: Bump Version and Update RC File
on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  bump-version:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}
      
      - name: Read or initialize version
        id: read_version
        run: |
          $VERSION_FILE = "version.txt"
          
          if (Test-Path $VERSION_FILE) {
            # ĞšĞ»ÑÑ‡ĞµĞ²Ğ¾Ğµ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Trim() Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ğ¾Ğ² Ğ¸ Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑĞ¾Ğ²
            $VERSION = (Get-Content -Path $VERSION_FILE -Raw).Trim()
            # Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ°
            if ($VERSION -notmatch '^\d+\.\d+\.\d+$') {
              Write-Host "âš ï¸ Invalid version format in version.txt: '$VERSION'. Resetting to 1.37.0"
              $VERSION = "1.37.0"
              $VERSION | Set-Content -Path $VERSION_FILE
            }
          } else {
            $VERSION = "1.37.0"
            $VERSION | Set-Content -Path $VERSION_FILE
            Write-Host "âœ… Created version.txt with initial version 1.37.0"
          }
          
          Write-Host "ğŸ“¦ Current version: $VERSION"
          echo "CURRENT_VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        shell: pwsh
      
      - name: Count changed lines since last commit
        id: count_changes
        run: |
          $DIFF = git diff HEAD~1 --shortstat 2>$null
          
          $INSERTIONS = 0
          $DELETIONS = 0
          
          if ($DIFF -match '(\d+)\s+insertion') { $INSERTIONS = [int]$matches[1] }
          if ($DIFF -match '(\d+)\s+deletion') { $DELETIONS = [int]$matches[1] }
          
          $TOTAL = $INSERTIONS + $DELETIONS
          Write-Host "âœï¸  Changed lines: $TOTAL"
          echo "TOTAL_LINES=$TOTAL" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        shell: pwsh
      
      - name: Get or initialize build number
        id: build_number
        run: |
          $BUILD_FILE = ".build_number"
          
          if (Test-Path $BUILD_FILE) {
            $buildNumber = [int](Get-Content $BUILD_FILE)
          } else {
            $buildNumber = 0
          }
          
          $buildNumber++
          $buildNumber | Set-Content $BUILD_FILE
          
          Write-Host "ğŸ”¨ Build number: $buildNumber"
          echo "BUILD_NUMBER=$buildNumber" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        shell: pwsh
      
      - name: Bump version based on changes
        id: bump_version
        run: |
          $CURRENT_VERSION = "${{ steps.read_version.outputs.CURRENT_VERSION }}".Trim()
          Write-Host "ğŸ”„ Current version: $CURRENT_VERSION"
          
          # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ Ñ€Ğ°Ğ·Ğ±Ğ¸ĞµĞ½Ğ¸Ñ Ğ²ĞµÑ€ÑĞ¸Ğ¸
          $v = $CURRENT_VERSION -split '\.'
          if ($v.Count -lt 3) {
            Write-Host "âŒ Error: Invalid version format '$CURRENT_VERSION'. Expected format x.x.x"
            exit 1
          }
          
          $MAJOR = [int]$v[0]
          $MINOR = [int]$v[1]
          $PATCH = [int]$v[2]
          $TOTAL_LINES = [int]${{ steps.count_changes.outputs.TOTAL_LINES }}
          
          Write-Host "ğŸ”¢ Version parts: MAJOR=$MAJOR, MINOR=$MINOR, PATCH=$PATCH"
          Write-Host "ğŸ“ Total changes: $TOTAL_LINES"
          
          if ($TOTAL_LINES -gt 1000) {
            $MAJOR++
            $MINOR = 0
            $PATCH = 0
            Write-Host "â« Major version bump (>$1000 changes)"
          } elseif ($TOTAL_LINES -gt 10) {
            $MINOR++
            $PATCH = 0
            Write-Host "â« Minor version bump (>$10 changes)"
          } else {
            $PATCH++
            Write-Host "â« Patch version bump (<=10 changes)"
          }
          
          $BUILD_NUMBER = ${{ steps.build_number.outputs.BUILD_NUMBER }}
          $NEW_VERSION = "$MAJOR.$MINOR.$PATCH"
          $FULL_VERSION = "$MAJOR.$MINOR.$PATCH.$BUILD_NUMBER"
          
          Write-Host "ğŸ‰ New version: $NEW_VERSION (build $BUILD_NUMBER)"
          echo "NEW_VERSION=$NEW_VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          echo "FULL_VERSION=$FULL_VERSION" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          
          # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ Ğ²ĞµÑ€ÑĞ¸Ñ Ğ² version.txt
          $NEW_VERSION | Set-Content -Path "version.txt"
        shell: pwsh
      
      - name: Create Gui_proxy.rc if missing
        run: |
          $CURRENT_VERSION = "${{ steps.read_version.outputs.CURRENT_VERSION }}".Trim()
          $parts = $CURRENT_VERSION -split '\.'
          $FILEVERSION_RC = "$($parts[0]),$($parts[1]),$($parts[2]),0"
          
          if (-not (Test-Path "Gui_proxy.rc")) {
            $rc = "VERSIONINFO`r`n" +
                  "FILEVERSION $FILEVERSION_RC`r`n" +
                  "PRODUCTVERSION $FILEVERSION_RC`r`n" +
                  "FILEOS 0x4`r`n" +
                  "FILETYPE 1`r`n" +
                  "{" + "`r`n" +
                  "    BLOCK `"StringFileInfo`"`r`n" +
                  "    {" + "`r`n" +
                  "        BLOCK `"040904B0`"`r`n" +
                  "        {" + "`r`n" +
                  "            VALUE `"FileDescription`", `"Gui_proxy Application`"`r`n" +
                  "            VALUE `"ProductName`", `"Gui_proxy`"`r`n" +
                  "            VALUE `"LegalCopyright`", `"Copyright (c) 2024`"`r`n" +
                  "            VALUE `"CompanyName`", `"Your Company`"`r`n" +
                  "            VALUE `"FileVersion`", `"$CURRENT_VERSION`"`r`n" +
                  "            VALUE `"ProductVersion`", `"$CURRENT_VERSION`"`r`n" +
                  "        }" + "`r`n" +
                  "    }" + "`r`n" +
                  "    BLOCK `"VarFileInfo`"`r`n" +
                  "    {" + "`r`n" +
                  "        VALUE `"Translation`", 0x409, 1200`r`n" +
                  "    }" + "`r`n" +
                  "}" + "`r`n"
            
            $rc | Set-Content -Path "Gui_proxy.rc" -Encoding UTF8
            Write-Host "âœ… Created new Gui_proxy.rc with version $CURRENT_VERSION"
          }
        shell: pwsh
      
      - name: Update RC file with new version
        run: |
          $NEW_VERSION = "${{ steps.bump_version.outputs.NEW_VERSION }}".Trim()
          $parts = $NEW_VERSION -split '\.'
          $FILEVERSION = "$($parts[0]),$($parts[1]),$($parts[2]),0"
          
          $content = Get-Content -Path "Gui_proxy.rc" -Raw
          
          $content = $content -replace 'FILEVERSION \d+,\d+,\d+,\d+', "FILEVERSION $FILEVERSION"
          $content = $content -replace 'PRODUCTVERSION \d+,\d+,\d+,\d+', "PRODUCTVERSION $FILEVERSION"
          $content = $content -replace 'VALUE "FileVersion",\s*"[^"]*"', "VALUE ""FileVersion"", ""$NEW_VERSION"""
          $content = $content -replace 'VALUE "ProductVersion",\s*"[^"]*"', "VALUE ""ProductVersion"", ""$NEW_VERSION"""
          
          $content | Set-Content -Path "Gui_proxy.rc" -Encoding UTF8
          Write-Host "âœ… Updated RC file to version $NEW_VERSION"
        shell: pwsh
      
      - name: Update README with version info
        run: |
          $NEW_VERSION = "${{ steps.bump_version.outputs.NEW_VERSION }}".Trim()
          $BUILD_NUMBER = "${{ steps.build_number.outputs.BUILD_NUMBER }}".Trim()
          $DATE = Get-Date -Format "yyyy-MM-dd"
          
          $CHANGELOG_ENTRY = "## [$NEW_VERSION] - $DATE`n`n"
          
          $TOTAL_LINES = ${{ steps.count_changes.outputs.TOTAL_LINES }}
          $CHANGELOG_ENTRY += "- ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ $TOTAL_LINES ÑÑ‚Ñ€Ğ¾Ğº ĞºĞ¾Ğ´Ğ°`n"
          
          if ($TOTAL_LINES -gt 1000) {
            $CHANGELOG_ENTRY += "- Major release (Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ)`n"
          } elseif ($TOTAL_LINES -gt 10) {
            $CHANGELOG_ENTRY += "- Minor release (Ğ½Ğ¾Ğ²Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸)`n"
          } else {
            $CHANGELOG_ENTRY += "- Patch release (Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº)`n"
          }
          
          $CHANGELOG_ENTRY += "`nBuild number: $BUILD_NUMBER`n`n---`n`n"
          
          if (Test-Path "README.md") {
            $readme = Get-Content -Path "README.md" -Raw
            
            if ($readme -match '##\s*Changelog') {
              $readme = $readme -replace '(##\s*Changelog)', "$CHANGELOG_ENTRY`$1"
            } 
            elseif ($readme -match '##\s*Version History') {
              $readme = $readme -replace '(##\s*Version History)', "$CHANGELOG_ENTRY`$1"
            }
            else {
              $readme = $CHANGELOG_ENTRY + $readme
            }
            
            $readme | Set-Content -Path "README.md" -Encoding UTF8
            Write-Host "âœ… Updated README.md with version info"
          }
          else {
            $newReadme = "# Gui_proxy`n`nApplication description`n`n$CHANGELOG_ENTRY"
            $newReadme | Set-Content -Path "README.md" -Encoding UTF8
            Write-Host "âœ… Created new README.md with version info"
          }
        shell: pwsh
      
      - name: Commit version changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add Gui_proxy.rc .build_number README.md version.txt
          
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "chore: version bump to v${{ steps.bump_version.outputs.NEW_VERSION }} (build ${{ steps.build_number.outputs.BUILD_NUMBER }})"
            git push origin main
          else
            echo "No changes to commit"
          fi
        shell: bash
